<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Focus</title>
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --glass-bg: rgba(20, 20, 25, 0.75);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            
            --base-width: 360px;
            --base-height: 520px;
            
            /* 光影動態變數 */
            --sheen-x: 50%;
            --sheen-y: 50%;
            --sheen-opacity: 0;
            --sheen-color: rgba(0, 242, 255, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; user-select: none; -webkit-user-drag: none; }

        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0f1014;
            background-image: 
                radial-gradient(circle at 50% 50%, #1a1c29 0%, #000 100%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            overflow: hidden;
            perspective: 1000px;
        }

        /* 3D Scene */
        .scene {
            position: relative;
            width: var(--base-width);
            height: var(--base-height);
            transform-style: preserve-3d;
            will-change: transform;
        }

        .card-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .card-wrapper.is-flipped { transform: rotateY(180deg); }

        /* Face Styles */
        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            transform-style: preserve-3d;
            overflow: hidden;
        }

        /* Dynamic Sheen Effect (全息光影) */
        .face::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(
                circle at var(--sheen-x) var(--sheen-y), 
                var(--sheen-color) 0%, 
                transparent 60%
            );
            opacity: var(--sheen-opacity);
            z-index: 1;
            pointer-events: none;
            mix-blend-mode: overlay;
            transition: opacity 0.3s;
        }

        .face.front { transform: rotateY(0deg); z-index: 2; }
        .face.back { transform: rotateY(180deg); justify-content: flex-start; }

        /* Animations */
        .squash-anim { animation: jelly-squash 0.2s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes jelly-squash {
            0% { transform: scale3d(1, 1, 1); }
            40% { transform: scale3d(1.05, 0.95, 1); }
            70% { transform: scale3d(0.95, 1.05, 1); }
            100% { transform: scale3d(1, 1, 1); }
        }

        /* 鬧鐘/完成動畫 */
        @keyframes ring-flash {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(0,242,255,0.2)); }
            50% { filter: drop-shadow(0 0 60px rgba(0,242,255,1)); }
        }
        @keyframes ring-flash-red {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255,0,85,0.2)); }
            50% { filter: drop-shadow(0 0 60px rgba(255,0,85,1)); }
        }
        .alarm-active svg { animation: ring-flash 0.5s infinite; }
        body.break-mode .alarm-active svg { animation: ring-flash-red 0.5s infinite; }

        /* 粒子特效 */
        .particle {
            position: absolute;
            width: 8px; height: 8px;
            background: var(--primary);
            border-radius: 50%;
            pointer-events: none;
            z-index: 999;
            box-shadow: 0 0 10px var(--primary);
        }
        body.break-mode .particle { background: var(--secondary); box-shadow: 0 0 10px var(--secondary); }

        /* UI Elements */
        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 50px; height: 50px;
            cursor: nwse-resize; z-index: 100; transform: translateZ(20px);
        }
        .resize-handle::after {
            content: ''; position: absolute; bottom: 15px; right: 15px; width: 12px; height: 12px;
            border-bottom: 4px solid var(--text-muted); border-right: 4px solid var(--text-muted); border-radius: 2px;
        }

        .header {
            transform: translateZ(40px); width: 100%; display: flex; justify-content: space-between; align-items: center;
            color: var(--text-muted); font-weight: 700; letter-spacing: 1px; font-size: 0.9rem; z-index: 10;
        }
        .icon-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: 0.2s; padding: 5px;}
        .icon-btn:hover { color: var(--text-main); transform: scale(1.2); }

        .timer-container {
            position: relative; width: 220px; height: 220px; transform: translateZ(60px);
            display: flex; justify-content: center; align-items: center; margin: auto; cursor: pointer;
        }
        .timer-container:active { transform: translateZ(50px) scale(0.98); transition: 0.1s; }

        svg { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 0 20px rgba(0,242,255,0.2)); }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .circle-bg { stroke: rgba(255,255,255,0.05); }
        .circle-progress { stroke: var(--primary); stroke-dasharray: 100 100; transition: stroke-dashoffset 0.5s linear; }

        .time-display {
            position: absolute; font-size: 3.5rem; font-weight: 800; color: var(--text-main);
            text-shadow: 0 0 30px rgba(0,242,255,0.4); font-variant-numeric: tabular-nums;
        }
        
        .minus-five-hint {
            position: absolute; top: 60%; font-size: 1.5rem; font-weight: bold; color: var(--secondary);
            opacity: 0; pointer-events: none; transform: translateZ(100px);
        }
        .minus-five-anim { animation: pop-up-fade 0.5s ease-out forwards; }
        @keyframes pop-up-fade {
            0% { opacity: 1; transform: translateZ(100px) translateY(0); }
            100% { opacity: 0; transform: translateZ(100px) translateY(-30px); }
        }

        .controls { display: flex; gap: 1rem; transform: translateZ(50px); margin-bottom: 2rem; z-index: 10; }
        .main-btn {
            border: none; background: rgba(255,255,255,0.05); color: var(--text-main);
            padding: 12px 32px; border-radius: 50px; cursor: pointer; font-weight: 700;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;
        }
        .main-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.15); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .main-btn:active { transform: scale(0.95); }
        .main-btn.primary { background: var(--primary); color: #000; box-shadow: 0 0 25px rgba(0,242,255,0.3); }
        .main-btn.primary:hover { background: #fff; box-shadow: 0 0 40px rgba(255,255,255,0.6); }

        /* Settings UI */
        .settings-content { width: 100%; padding-top: 2rem; transform: translateZ(30px); display: flex; flex-direction: column; gap: 1.5rem; }
        .settings-group { width: 100%; }
        .settings-group label { display: flex; justify-content: space-between; color: var(--text-muted); margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; }
        .range-wrap { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 15px; }
        input[type=range] { flex-grow: 1; -webkit-appearance: none; background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--primary); transition: transform 0.2s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); }
        .range-value { color: #fff; font-weight: bold; width: 30px; text-align: right; }

        .lang-switch { display: flex; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 3px; width: fit-content; margin-bottom: 2rem;}
        .lang-btn { background: transparent; color: var(--text-muted); border: none; padding: 5px 15px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .lang-btn.active { background: rgba(255,255,255,0.15); color: #fff; font-weight: bold; }

        .action-row { display: flex; gap: 10px; margin-top: auto; width: 100%; transform: translateZ(50px); }
        .action-row button { flex: 1; }

        /* Color Themes */
        body.break-mode { 
            --primary: #ff0055; 
            --sheen-color: rgba(255, 0, 85, 0.2);
        }
    </style>
</head>
<body>

    <div class="scene" id="scene">
        <div class="card-wrapper" id="cardWrapper">
            
            <div class="face front">
                <div class="resize-handle" id="resizeHandle"></div>
                <div class="header">
                    <span data-i18n="title">FOCUS MODULE</span>
                    <button class="icon-btn" id="toSettingsBtn">⚙</button>
                </div>

                <div class="timer-container" id="timerArea">
                    <svg viewBox="0 0 220 220">
                        <circle cx="110" cy="110" r="100" class="circle-bg"></circle>
                        <path class="circle-progress" id="progressRing" d="M110,10 a100,100 0 0,1 0,200 a100,100 0 0,1 0,-200" pathLength="100" />
                    </svg>
                    <div class="time-display" id="timeDisplay">25:00</div>
                    <div class="minus-five-hint" id="minusAnim">-5s</div>
                </div>

                <div class="controls">
                    <button class="main-btn primary" id="startBtn" data-i18n="start">START</button>
                    <button class="main-btn" id="resetBtn" data-i18n="reset">RESET</button>
                </div>
            </div>

            <div class="face back">
                <div class="header">
                    <span data-i18n="settings">SYSTEM CONFIG</span>
                </div>
                
                <div class="settings-content">
                    <div class="lang-switch">
                        <button class="lang-btn active" data-lang="en">EN</button>
                        <button class="lang-btn" data-lang="zh">繁中</button>
                    </div>

                    <div class="settings-group">
                        <label><span data-i18n="focusTime">Focus Duration</span> <span id="focusValDisplay">25</span></label>
                        <div class="range-wrap">
                            <input type="range" id="focusInput" min="1" max="90" value="25">
                        </div>
                    </div>

                    <div class="settings-group">
                        <label><span data-i18n="breakTime">Break Duration</span> <span id="breakValDisplay">5</span></label>
                        <div class="range-wrap">
                            <input type="range" id="breakInput" min="1" max="30" value="5">
                        </div>
                    </div>
                </div>

                <div class="action-row">
                    <button class="main-btn" id="cancelSettingsBtn" data-i18n="back">BACK</button>
                    <button class="main-btn primary" id="saveSettingsBtn" data-i18n="confirm">CONFIRM</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const TRANSLATIONS = {
            en: {
                title: "FOCUS MODULE", settings: "SYSTEM CONFIG", start: "START", pause: "PAUSE", resume: "RESUME", reset: "RESET",
                focusTime: "Focus Duration (min)", breakTime: "Break Duration (min)", back: "BACK", confirm: "CONFIRM",
                sessionDone: "Focus Session Complete!", breakDone: "Break Time Over!"
            },
            zh: {
                title: "專注模式", settings: "系統設定", start: "開始", pause: "暫停", resume: "繼續", reset: "重置",
                focusTime: "專注時長 (分)", breakTime: "休息時長 (分)", back: "返回", confirm: "確認",
                sessionDone: "專注結束！休息一下。", breakDone: "休息結束！回到工作。"
            }
        };

        class Spring {
            constructor(stiffness = 0.05, damping = 0.85) {
                this.target = 0; this.current = 0; this.velocity = 0;
                this.stiffness = stiffness; this.damping = damping;
            }
            update() {
                const force = (this.target - this.current) * this.stiffness;
                this.velocity += force; this.velocity *= this.damping;
                this.current += this.velocity;
            }
            impulse(amount) { this.velocity += amount; }
        }

        class PomodoroApp {
            constructor() {
                this.lang = 'en';
                this.settings = { focus: 25, break: 5 };
                this.state = {
                    timeLeft: 25 * 60, initialTime: 25 * 60,
                    isRunning: false, mode: 'focus', timerId: null, scale: 1.0
                };

                this.physics = {
                    rotateX: new Spring(0.04, 0.85),
                    rotateY: new Spring(0.04, 0.85),
                    scale: new Spring(0.1, 0.75),
                };
                this.physics.scale.current = 1.0; this.physics.scale.target = 1.0;

                this.dom = this.cacheDOM();
                this.init();
            }

            cacheDOM() {
                return {
                    scene: document.getElementById('scene'),
                    cardWrapper: document.getElementById('cardWrapper'),
                    timerArea: document.getElementById('timerArea'),
                    display: document.getElementById('timeDisplay'),
                    ring: document.getElementById('progressRing'),
                    minusHint: document.getElementById('minusAnim'),
                    startBtn: document.getElementById('startBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    toSettingsBtn: document.getElementById('toSettingsBtn'),
                    saveBtn: document.getElementById('saveSettingsBtn'),
                    cancelBtn: document.getElementById('cancelSettingsBtn'),
                    focusInput: document.getElementById('focusInput'),
                    breakInput: document.getElementById('breakInput'),
                    focusVal: document.getElementById('focusValDisplay'),
                    breakVal: document.getElementById('breakValDisplay'),
                    langBtns: document.querySelectorAll('.lang-btn'),
                    resizeHandle: document.getElementById('resizeHandle'),
                    i18nElements: document.querySelectorAll('[data-i18n]'),
                    body: document.body
                };
            }

            init() {
                this.initListeners();
                this.loopPhysics();
                this.updateDisplay();
                this.updateText();
                
                // 預先檢查通知權限 (非強制)
                if ("Notification" in window && Notification.permission === "default") {
                    // 這裡不直接觸發以免被瀏覽器擋掉，改在 start() 觸發
                }
            }

            loopPhysics() {
                this.physics.rotateX.update();
                this.physics.rotateY.update();
                this.physics.scale.update();

                const rX = this.physics.rotateX.current;
                const rY = this.physics.rotateY.current;
                const s = this.physics.scale.current * this.state.scale;

                this.dom.scene.style.transform = `scale(${s}) rotateX(${rX}deg) rotateY(${rY}deg)`;

                const sheenX = 50 + (rY * 2); 
                const sheenY = 50 - (rX * 2);
                document.body.style.setProperty('--sheen-x', `${sheenX}%`);
                document.body.style.setProperty('--sheen-y', `${sheenY}%`);
                document.body.style.setProperty('--sheen-opacity', Math.min(1, (Math.abs(rX) + Math.abs(rY)) / 20 + 0.1));

                requestAnimationFrame(() => this.loopPhysics());
            }

            initListeners() {
                document.addEventListener('mousemove', (e) => {
                    if (this.isResizing) return;
                    const w = window.innerWidth; const h = window.innerHeight;
                    this.physics.rotateY.target = (e.clientX - w / 2) / (w / 30);
                    this.physics.rotateX.target = -(e.clientY - h / 2) / (h / 30);
                });

                document.addEventListener('mouseleave', () => {
                    this.physics.rotateY.target = 0; this.physics.rotateX.target = 0;
                });

                this.dom.timerArea.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    this.subtractTime();
                    this.physics.scale.impulse(-0.1);
                    this.physics.rotateX.impulse(5);
                });

                this.dom.startBtn.addEventListener('click', () => { 
                    this.physics.scale.impulse(-0.05);
                    this.toggleTimer(); 
                });
                this.dom.resetBtn.addEventListener('click', () => {
                    this.physics.scale.impulse(-0.05);
                    this.reset();
                });

                this.dom.toSettingsBtn.addEventListener('click', () => {
                    this.openSettings();
                    this.physics.rotateY.impulse(10);
                });
                this.dom.saveBtn.addEventListener('click', () => this.saveSettings());
                this.dom.cancelBtn.addEventListener('click', () => this.closeSettings());

                this.dom.langBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.lang = e.target.dataset.lang;
                        this.dom.langBtns.forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.updateText();
                    });
                });

                this.dom.focusInput.addEventListener('input', (e) => this.dom.focusVal.textContent = e.target.value);
                this.dom.breakInput.addEventListener('input', (e) => this.dom.breakVal.textContent = e.target.value);

                this.initResize();
            }

            initResize() {
                this.isResizing = false;
                let startX, startScale;
                this.dom.resizeHandle.addEventListener('mousedown', (e) => {
                    this.isResizing = true; startX = e.clientX; startScale = this.state.scale;
                    this.dom.resizeHandle.style.cursor = 'grabbing'; e.preventDefault();
                });
                document.addEventListener('mousemove', (e) => {
                    if (!this.isResizing) return;
                    const deltaX = e.clientX - startX;
                    this.state.scale = Math.max(0.6, Math.min(1.8, startScale + deltaX * 0.002));
                    this.physics.scale.target = 1.0 + Math.sin(deltaX * 0.1) * 0.02;
                });
                document.addEventListener('mouseup', () => {
                    if (this.isResizing) {
                        this.isResizing = false; this.dom.resizeHandle.style.cursor = 'nwse-resize'; this.physics.scale.target = 1.0;
                    }
                });
            }

            updateDisplay() {
                const total = Math.max(0, this.state.timeLeft);
                const m = Math.floor(total / 60).toString().padStart(2, '0');
                const s = (total % 60).toString().padStart(2, '0');
                const timeString = `${m}:${s}`;
                
                this.dom.display.textContent = timeString;
                
                // 1. 網頁標題倒數 (Tab Title)
                const status = this.state.mode === 'focus' ? 'Focus' : 'Break';
                document.title = this.state.isRunning ? `(${timeString}) ${status} - Pomodoro` : `Pomodoro ${status}`;

                const pct = (this.state.timeLeft / this.state.initialTime) * 100;
                this.dom.ring.style.strokeDashoffset = Math.max(0, 100 - pct);
            }

            toggleTimer() {
                if (this.state.isRunning) this.pause();
                else this.start();
            }

            start() {
                if (this.state.isRunning) return;
                
                // 請求通知權限
                if ("Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }

                this.state.isRunning = true;
                this.dom.scene.classList.remove('alarm-active');
                this.updateText();
                
                this.state.timerId = setInterval(() => {
                    if (this.state.timeLeft > 0) {
                        this.state.timeLeft--;
                        this.updateDisplay();
                    } else {
                        this.complete();
                    }
                }, 1000);
            }

            pause() {
                this.state.isRunning = false;
                clearInterval(this.state.timerId);
                this.updateText();
            }

            reset() {
                this.pause();
                const base = this.state.mode === 'focus' ? this.settings.focus : this.settings.break;
                this.state.initialTime = base * 60;
                this.state.timeLeft = this.state.initialTime;
                this.dom.ring.style.transition = 'stroke-dashoffset 0.5s ease-out';
                this.dom.scene.classList.remove('alarm-active');
                this.updateDisplay();
                setTimeout(() => this.dom.ring.style.transition = 'stroke-dashoffset 1s linear', 500);
            }

            subtractTime() {
                if (this.state.timeLeft <= 0) return;
                this.state.timeLeft = Math.max(0, this.state.timeLeft - 5);
                this.updateDisplay();
                this.dom.minusHint.classList.remove('minus-five-anim');
                void this.dom.minusHint.offsetWidth;
                this.dom.minusHint.classList.add('minus-five-anim');
                this.dom.scene.classList.remove('squash-anim');
                void this.dom.scene.offsetWidth;
                this.dom.scene.classList.add('squash-anim');
            }

            complete() {
                this.pause();
                this.state.timeLeft = 0;
                this.updateDisplay();
                
                // 2. 動畫特效 (Particles + Glow)
                this.dom.scene.classList.add('alarm-active');
                this.spawnParticles();

                // 3. 原生系統通知 (Windows Style)
                const msg = this.state.mode === 'focus' ? TRANSLATIONS[this.lang].sessionDone : TRANSLATIONS[this.lang].breakDone;
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("Pomodoro Timer", {
                        body: msg,
                        icon: "https://cdn-icons-png.flaticon.com/512/2928/2928750.png", // 通用時鐘圖示
                        requireInteraction: true // 確保通知不會自動消失（視系統而定）
                    });
                } else {
                    // Fallback if permission denied
                    setTimeout(() => alert(msg), 200);
                }

                // Auto switch hint logic could go here
            }

            spawnParticles() {
                const rect = this.dom.timerArea.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                for (let i = 0; i < 40; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle');
                    document.body.appendChild(p); // Append to body to avoid 3D transform skewing
                    
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 60 + Math.random() * 140;
                    const tx = Math.cos(angle) * velocity;
                    const ty = Math.sin(angle) * velocity;
                    
                    p.style.left = centerX + 'px';
                    p.style.top = centerY + 'px';
                    p.style.transition = `all 0.8s cubic-bezier(0.165, 0.84, 0.44, 1)`;
                    
                    requestAnimationFrame(() => {
                        p.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
                        p.style.opacity = 0;
                    });
                    setTimeout(() => p.remove(), 800);
                }
            }

            switchMode(newMode) {
                this.state.mode = newMode;
                document.body.classList.toggle('break-mode', newMode === 'break');
                this.reset();
            }

            openSettings() {
                this.dom.focusInput.value = this.settings.focus;
                this.dom.breakInput.value = this.settings.break;
                this.dom.focusVal.textContent = this.settings.focus;
                this.dom.breakVal.textContent = this.settings.break;
                this.dom.cardWrapper.classList.add('is-flipped');
            }

            closeSettings() { this.dom.cardWrapper.classList.remove('is-flipped'); }

            saveSettings() {
                this.settings.focus = parseInt(this.dom.focusInput.value);
                this.settings.break = parseInt(this.dom.breakInput.value);
                if (!this.state.isRunning) this.reset();
                this.closeSettings();
            }

            updateText() {
                const t = TRANSLATIONS[this.lang];
                this.dom.i18nElements.forEach(el => {
                    const key = el.dataset.i18n;
                    if (key && t[key]) {
                        if (key === 'start') {
                            el.textContent = this.state.isRunning ? t.pause : (this.state.timeLeft < this.state.initialTime && this.state.timeLeft > 0 ? t.resume : t.start);
                        } else {
                            el.textContent = t[key];
                        }
                    }
                });
            }
        }

        const app = new PomodoroApp();
    </script>
</body>
</html>